# EasyRide Database Schema

This document defines the database schema for the EasyRide Bus Ticket Management System, updated to match your Supabase `profiles` and `locations` tables.

\`\`\`sql
-- =============================================
-- 1. EXISTING SUPABASE TABLES (Reference Only)
-- =============================================

-- Table: profiles (Already exists in your Supabase)
-- id: uuid (PK, references auth.users)
-- full_name: text
-- phone_number: text
-- student_id: text
-- role: text ('admin', 'student', etc.)

-- Table: locations (Already exists in your Supabase)
-- id: int8 (PK)
-- name: text (e.g., 'Gulshan 2', 'Badda')

-- =============================================
-- 2. ENUM TYPE DEFINITIONS
-- =============================================

-- Bus & Route Statuses
CREATE TYPE bus_type_enum AS ENUM ('standard', 'express', 'deluxe');
CREATE TYPE bus_status_enum AS ENUM ('active', 'inactive', 'maintenance');
CREATE TYPE route_status_enum AS ENUM ('active', 'inactive', 'maintenance');
CREATE TYPE assignment_status_enum AS ENUM ('scheduled', 'in_progress', 'completed', 'cancelled');

-- Booking & Payments
CREATE TYPE booking_status_enum AS ENUM ('confirmed', 'cancelled', 'completed');
CREATE TYPE payment_status_enum AS ENUM ('pending', 'paid', 'refunded');
CREATE TYPE payment_method_enum AS ENUM ('card', 'mobile_money', 'cash');

-- =============================================
-- 3. TABLE DEFINITIONS
-- =============================================

-- Table: easyride_buses
CREATE TABLE easyride_buses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    bus_number VARCHAR(50) NOT NULL UNIQUE,
    bus_type bus_type_enum NOT NULL,
    capacity INT NOT NULL,
    manufacturer VARCHAR(100),
    registration_date DATE,
    status bus_status_enum DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_routes
-- UPDATED: Now references your 'locations' table
CREATE TABLE easyride_routes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL, -- e.g., "Route 1: Gulshan to Campus"
    origin_id BIGINT REFERENCES locations(id),      -- Link to 'locations'
    destination_id BIGINT REFERENCES locations(id), -- Link to 'locations'
    distance_km DECIMAL(8,2),
    estimated_time_minutes INT,
    route_status route_status_enum DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_bus_assignments
CREATE TABLE easyride_bus_assignments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    route_id BIGINT REFERENCES easyride_routes(id) ON DELETE CASCADE,
    bus_id BIGINT REFERENCES easyride_buses(id) ON DELETE CASCADE,
    driver_id UUID REFERENCES profiles(id), -- UPDATED: References 'profiles' (UUID)
    departure_time TIME,
    arrival_time TIME,
    assignment_date DATE,
    status assignment_status_enum DEFAULT 'scheduled',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_bookings
-- UPDATED: References 'profiles' and includes location details if needed
CREATE TABLE easyride_bookings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    passenger_id UUID REFERENCES profiles(id), -- UPDATED: References 'profiles' (UUID)
    bus_assignment_id BIGINT REFERENCES easyride_bus_assignments(id),
    booking_reference VARCHAR(50) UNIQUE NOT NULL,
    seat_number INT,
    
    -- Optional: If you want to track specific pickup/dropoff for this passenger
    -- (Only needed if they differ from the route's main origin/dest)
    pickup_location_id BIGINT REFERENCES locations(id),
    dropoff_location_id BIGINT REFERENCES locations(id),

    booking_status booking_status_enum DEFAULT 'confirmed',
    booking_date TIMESTAMPTZ DEFAULT NOW(),
    journey_date DATE,
    payment_status payment_status_enum DEFAULT 'pending',
    amount_paid DECIMAL(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_qr_codes
CREATE TABLE easyride_qr_codes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    booking_id BIGINT REFERENCES easyride_bookings(id) ON DELETE CASCADE,
    qr_code_data VARCHAR(500) NOT NULL,
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    is_scanned BOOLEAN DEFAULT FALSE,
    scanned_at TIMESTAMPTZ
);
\`\`\`
