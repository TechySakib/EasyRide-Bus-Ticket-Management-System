# EasyRide Database Schema

This document defines the database schema for the EasyRide Bus Ticket Management System, including Enum types and Table definitions.

\`\`\`sql
-- =============================================
-- 1. ENUM TYPE DEFINITIONS
-- =============================================

-- Users & Roles
CREATE TYPE user_role AS ENUM ('admin', 'driver', 'passenger', 'support');

-- Bus & Route Statuses
CREATE TYPE bus_type_enum AS ENUM ('standard', 'express', 'deluxe');
CREATE TYPE bus_status_enum AS ENUM ('active', 'inactive', 'maintenance');
CREATE TYPE route_status_enum AS ENUM ('active', 'inactive', 'maintenance');
CREATE TYPE assignment_status_enum AS ENUM ('scheduled', 'in_progress', 'completed', 'cancelled');

-- Booking & Payments
CREATE TYPE booking_status_enum AS ENUM ('confirmed', 'cancelled', 'completed');
CREATE TYPE payment_status_enum AS ENUM ('pending', 'paid', 'refunded');
CREATE TYPE payment_method_enum AS ENUM ('card', 'mobile_money', 'cash');

-- Subscriptions
CREATE TYPE subscription_type_enum AS ENUM ('monthly', 'quarterly', 'annual');
CREATE TYPE subscription_status_enum AS ENUM ('active', 'expired', 'cancelled');

-- Support & Reports
CREATE TYPE report_type_enum AS ENUM ('daily_revenue', 'occupancy', 'route_performance', 'customer_feedback');
CREATE TYPE ticket_category_enum AS ENUM ('booking', 'payment', 'bus_quality', 'driver_behavior', 'other');
CREATE TYPE ticket_status_enum AS ENUM ('open', 'in_progress', 'resolved', 'closed');
CREATE TYPE ticket_priority_enum AS ENUM ('low', 'medium', 'high', 'urgent');
CREATE TYPE activity_type_enum AS ENUM ('created', 'assigned', 'commented', 'status_changed', 'closed');
CREATE TYPE message_type_enum AS ENUM ('user', 'bot', 'support');

-- =============================================
-- 2. TABLE DEFINITIONS
-- =============================================

-- Table: easyride_users
-- Note: In Supabase, you might prefer linking to auth.users or public.profiles
CREATE TABLE easyride_users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    role user_role DEFAULT 'passenger',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_buses
CREATE TABLE easyride_buses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    bus_number VARCHAR(50) NOT NULL UNIQUE,
    bus_type bus_type_enum NOT NULL,
    capacity INT NOT NULL,
    manufacturer VARCHAR(100),
    registration_date DATE,
    maintenance_due_date DATE,
    status bus_status_enum DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_routes
CREATE TABLE easyride_routes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    origin_location VARCHAR(255) NOT NULL,
    destination_location VARCHAR(255) NOT NULL,
    distance_km DECIMAL(8,2),
    estimated_time_minutes INT,
    route_status route_status_enum DEFAULT 'active',
    created_by BIGINT REFERENCES easyride_users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_bus_assignments
CREATE TABLE easyride_bus_assignments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    route_id BIGINT REFERENCES easyride_routes(id) ON DELETE CASCADE,
    bus_id BIGINT REFERENCES easyride_buses(id) ON DELETE CASCADE,
    driver_id BIGINT REFERENCES easyride_users(id),
    departure_time TIME,
    arrival_time TIME,
    assignment_date DATE,
    status assignment_status_enum DEFAULT 'scheduled',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_bookings
CREATE TABLE easyride_bookings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    passenger_id BIGINT REFERENCES easyride_users(id),
    bus_assignment_id BIGINT REFERENCES easyride_bus_assignments(id),
    booking_reference VARCHAR(50) UNIQUE NOT NULL,
    seat_number INT,
    booking_status booking_status_enum DEFAULT 'confirmed',
    booking_date TIMESTAMPTZ DEFAULT NOW(),
    journey_date DATE,
    payment_status payment_status_enum DEFAULT 'pending',
    payment_method payment_method_enum,
    amount_paid DECIMAL(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_chat_messages
CREATE TABLE easyride_chat_messages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT REFERENCES easyride_users(id),
    bus_assignment_id BIGINT REFERENCES easyride_bus_assignments(id),
    message_text TEXT NOT NULL,
    message_type message_type_enum DEFAULT 'user',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_otp_verifications
CREATE TABLE easyride_otp_verifications (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT REFERENCES easyride_users(id),
    phone VARCHAR(20),
    otp_code VARCHAR(6),
    is_verified BOOLEAN DEFAULT FALSE,
    attempts INT DEFAULT 0,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_qr_codes
CREATE TABLE easyride_qr_codes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    booking_id BIGINT REFERENCES easyride_bookings(id) ON DELETE CASCADE,
    qr_code_data VARCHAR(500) NOT NULL,
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    scanned_at TIMESTAMPTZ,
    is_scanned BOOLEAN DEFAULT FALSE
);

-- Table: easyride_bus_tracking
CREATE TABLE easyride_bus_tracking (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    bus_assignment_id BIGINT REFERENCES easyride_bus_assignments(id),
    latitude DECIMAL(11,8),
    longitude DECIMAL(11,8),
    current_stop VARCHAR(255),
    speed_kmh INT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_subscriptions
CREATE TABLE easyride_subscriptions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    passenger_id BIGINT REFERENCES easyride_users(id),
    subscription_type subscription_type_enum NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status subscription_status_enum DEFAULT 'active',
    price DECIMAL(10,2),
    trip_limit INT,
    trips_used INT DEFAULT 0,
    discount_percentage INT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_subscription_bookings
CREATE TABLE easyride_subscription_bookings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    subscription_id BIGINT REFERENCES easyride_subscriptions(id),
    bus_assignment_id BIGINT REFERENCES easyride_bus_assignments(id),
    booking_date TIMESTAMPTZ DEFAULT NOW(),
    journey_date DATE,
    booking_status booking_status_enum DEFAULT 'confirmed',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_reports
CREATE TABLE easyride_reports (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    report_type report_type_enum NOT NULL,
    generated_by BIGINT REFERENCES easyride_users(id),
    report_date DATE,
    report_data TEXT, -- Can use JSONB for structured data in Supabase
    file_path VARCHAR(500),
    generated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Table: easyride_support_tickets
CREATE TABLE easyride_support_tickets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ticket_number VARCHAR(50) UNIQUE NOT NULL,
    user_id BIGINT REFERENCES easyride_users(id),
    booking_id BIGINT REFERENCES easyride_bookings(id),
    issue_title VARCHAR(255) NOT NULL,
    issue_description TEXT,
    category ticket_category_enum,
    status ticket_status_enum DEFAULT 'open',
    priority ticket_priority_enum DEFAULT 'medium',
    assigned_to BIGINT REFERENCES easyride_users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    resolved_at TIMESTAMPTZ
);

-- Table: easyride_ticket_activities
CREATE TABLE easyride_ticket_activities (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ticket_id BIGINT REFERENCES easyride_support_tickets(id) ON DELETE CASCADE,
    activity_type activity_type_enum NOT NULL,
    performed_by BIGINT REFERENCES easyride_users(id),
    comment_text TEXT,
    previous_status VARCHAR(50),
    new_status VARCHAR(50),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
\`\`\`
